[{"title":"openstack虚拟机网络流向详解","date":"2018-01-14T05:32:04.000Z","path":"2018/01/14/openstack虚拟机网络流向详解/","text":"openstack网络组件1.网络节点组件1231.DHCP agent(namespace,dnsmasq)，用于创建和管理DHCP Server,每个虚拟网络都有一个DHCP Server，为这个网络里的虚拟机提供ip,当然你也可以关掉DHCP。2.Metadata agent(namespace,metadata进程，cloud-init)。Instance在启动时需要访问nova-metadata-api来获取instance的一些信息，比如hostname、ip、public key等，但是Instance启动时并没有ip，此时就是metadata-agent来使instance通过dhcp-agent或l3-agent与nova-metadata-api通信。3.L3 agent(namespace,iptables),用于创建和管理虚拟路由器，可以在router上配置防火墙策略。 2.计算节点组件1231.OpenvSwitch agent2.Linux Bridge由于OVS不能直接操作iptables来实现安全组，所以老版本比如L版在VM和OVS中间添加了LinuxBridge来实现安全组。O版提供native openvswitch firewall driver可以不需要LinuxBridge 网络通信场景1.区域内VM东西向通信（instance之间网络流向） 同网段节点1上的instance1向节点2上的instance2发送报文，报文在节点1上会经过以下步骤：123456781).Instance 1的接口（1）通过veth pair将报文转发到linux bridge端口（2）。2)安全组规则（3）在linux bridge上处理报文的过滤。3)Linux bridge连接OVS的端口（4）通过veth pair将报文转发到OVS br-int连接linux bridge的端口（5）4)OVS br-int为报文添加一个内部VLAN tag。5)OVS br-int将内部VLAN tag转换为内部隧道ID。6)OVS br-int通过patch端口（6）将报文转发到OVS br-tun patch端口（7）。7)OVS br-tun（8）使用VNI 101封装数据包8)Overlay网络的物理网卡（9）通过overlay网络（10）将报文转发到计算节点2。 报文在节点2上经过以下步骤：123456781）Overlay网络的物理网卡（11）将报文转发到OVS br-tun（12）。2）OVS br-tun解封装报文并添加一个内部隧道ID。3）OVS br-tun将内部隧道ID转换为内部VLAN tag。4）OVS br-tun patch端口（13）将报文转发到OVS br-int patch丁端口（14）。5）OVS br-int从报文中删除内部VLAN标记6）OVS br-int 连接linux bridge的端口（15）通过veth pair将报文转发到linux bridge连接OVS的端口（16）。7）安全组规则（17）在linux bridge上处理报文的过滤。8）Linux bridge端口（18）通过veth pair将报文转发到instance 2的接口（19） 不同网段Instance1和instance2在同一个主机但属于不同的租户网络，报文在计算节点上经过以下步骤：123456781) instance 1的接口（1）通过veth pair将报文转发到linux bridge端口（2）2)安全组规则（3）在linux bridge处理报文的过滤3）Linux bridge连接OVS的端口（4）通过veth pair将报文转发到OVS br-int连接linux bridge的端口（5）。4）OVS br-int为报文添加了一个内部VLAN tag。5）OVS br-int将内部VLAN tag转换为内部隧道ID。6）OVS br-int的patch端口（6）将数据包转发到OVS br-tun的patch端口（7）7）OVS br-tun（8）使用VNI 101封装报文8）Overlay网络的物理网卡（9）通过overlay网络（10）将报文转发到网络节点。 报文在网络节点上经过以下步骤：123456781）Overlay网络的物理网卡（11）将报文转发到OVS br-tun（12）。2）OVS br-tun解封装报文并添加一个内部隧道ID。3）OVS br-tun将内部隧道ID转换为内部VLAN tag。4）OVS br-tun的patch端口（13）将报文转发到OVS br-int的patch端口（14）。5）用于租户网络1的OVS br-int端口（15）去除内部VLAN tag，并将该报文转发到router namespace中的租户网络1接口（16）。6）router通过租户网络2接口（17）将报文发送到下一跳IP地址，即租户网络2上的网关IP地址。7）router将报文转发到租户网络2的OVS br-int端口（18）后续的报文从router到instance 2的步骤原路返回。 2.VM南北向通信（instance通过router访问外部网络） instance通过router访问外部网络时，报文在计算节点经过以下步骤：123456781）Instance接口（1）通过veth pair将报文转发到linux bridge端口（2）。2）安全组规则（3）在linux bridge处理报文的过滤。3）Linux bridge连接OVS的端口（4）通过veth pair将报文转发到OVS连接linux bridge的端口（5）。4）OVS br-int为报文添加了一个内部VLAN tag。5）OVS br-int将内部VLANtag转换为内部隧道ID。6）OVS br-int的patch端口（6）将报文转发到OVS br-tun的patch端口（7）。7）OVS br-tun（8）使用VNI 101封装报文。8）Overlay网络的物理网卡（9）通过overlay网络（10）将报文转发到网络节点。 报文在网络节点经过以下步骤：12345678910111）Overlay网络的物理网卡（11）将报文转发到OVS br-tun（12）。2）OVS br-tun解封装报文并添加一个内部隧道ID。3）OVS br-tun将内部隧道ID转换为内部VLAN tag。4）OVS br-tun的patch端口（13）将分组转发到OVS br-int的patch端口（14）。5）用于租户网络的OVS br-int端口（15）去除内部VLAN tag，并将报文转发到router namespace中的租户网络接口（16）。6）router将报文转发给provider网络的OVS br-int端口（18）。7）OVS br-int将内部VLAN tag添加到报文。8）OVS br-int的patch端口（19）将报文转发给OVS br-provider的patch端口（20）。9）OVS br-provider将内部VLAN tag转换为实际的VLAN tag 101。10）OVS br-provider的端口（21）将报文转发给物理网络接口（22）。11）物理网络接口通过物理网络将报文转发到因特网（23）。 常见故障现象和排除方法1.DHCP请求失败12341).neutron agent-list 检查dhcp agent服务状态2).ip netns exec qdhcp-xxxxxxxxxxxx bash进入namespace，查看dnsmasq进程是否运行中 ps aux | grep dns 3).进入namespace tcpdump抓包查看dhcp接口是否收到dhcp请求，如果没有收到，说明二层网络不通。4).结合虚拟机通信数据流图依次在流量路径上用tcpdump抓包，判断网络连接不通的原因。 2.Metadata获取失败12341).neutron agent-list 检查metadata agent服务状态2).对于没有连接到router的网络，需要配置enable_isolated_metadata = true后metadata服务才会生效，配置的效果是会在dhcp namespace中启动metadata相关进程。3).虚拟机本身需要已经安装并enable cloud-init服务才会在启动时获取metadata。4).如果已经拿到DHCP信息，基本可以排除网络的原因，主要检查服务的状态。 3.Arp请求失败1231).网络通信首先需要发送ARP请求获取MAC地址，网络不通时可以使用arp –a查看本地ARP缓存。2).如果无法通过ARP请求获取目标IP或网关IP的MAC地址，说明二层网络不通。3).结合虚拟机通信数据流图依次在流量路径上用tcpdump抓包，判断网络连接不通的原因。 4.Arp请求成功，IP通信失败12341).使用arp –a查看本地ARP缓存，如果已经获取到了目标地址的MAC地址，说明源和目的之间的二层网络正常，可以检查路径上的安全组或防火墙的配置，检查是否允许使用的协议通过。2).Neutron的安全组默认只允许报文以端口的IP和MAC地址向外发送报文，如果有需要（比如虚拟机的服务创建了新的IP或MAC地址），可以关闭端口的安全组功能： neutron port-update --no-security-groups $port_id neutron port-update $port_id --port-security-enabled=False 5.OVS和Openflow相关操作1231).如果以上的网络检查做完还是无法解决问题，可以通过OVS的命令检查OVS和Openflow流表的状态。 ovs-vsctl show查看OVS的bridge和port的信息。 ovs-ofctl dump-flows &#123;BRIDGE_NAME&#125;查看bridge中的Openflow流表的情况。","categories":[{"name":"技术","slug":"技术","permalink":"http://yoursite.com/categories/技术/"}],"tags":[{"name":"openstack","slug":"openstack","permalink":"http://yoursite.com/tags/openstack/"}]},{"title":"Linux字符管理命令","date":"2018-01-09T04:23:18.000Z","path":"2018/01/09/Linux字符管理命令/","text":"平时工作中经常用到grep、awk、sort、sed等字符管理命令，但是自己记性又不好，每次需要去google，索性总结一下，方便以后查询。 cut 截取所需字符-d “n”:定义分界符,即点位-f n:取第几位的字符1234例如：以空格符为分界符,进行第2位截取 cut -d \" \" -f 2 /etc/fstab 以冒号为分界符，进行第1，3位截取 cut -d \":\" -f 1,3 /etc/passwd sed 通过指定的正则表达式完成指定关键字的过滤、截取、修改等操作1.关于替换： 1).sed替换的基本语法为: sed ‘s/原字符串/替换字符串/‘ filename s 表示替换 特殊字符需要使用反斜线“\\”进行转义，单引号是不能用反斜线转义，要用反斜线的话使用双引号。 要处理的字符串包含单引号也用双引号。 注意：在末尾加g替换每一个匹配的关键字，否则只替换每一行的第一个字符串12替换所有匹配关键字 sed 's/原字符串/替换字符串/g' filename 2）三根斜线也可换成别的符号，只要紧跟s定义即可12将分隔符换成问号”?”: sed 's?原字符串?替换字符串?' 注意：sed处理过的输出是直接输出到屏幕上的,使用参数”i”直接在文件中替换 3）多个替换可以在同一条命令中执行,用分号”;”分隔，其格式为:12同时执行两个替换规则 sed 's/^/添加的头部&amp;/g；s/$/&amp;添加的尾部/g' 4）一些特殊字符的使用 ”^”表示行首 ”$”符号如果在引号中表示行尾，但是在引号外却表示末行(最后一行)2.关于删除： 1）d 删除指定行,要在文件内删除，同样加参数i123456删除文件的第1-3行 sed '1,3d' filename 删除文件的第3行到最后一行 sed ‘3,$d’ filename 删除含有指定字段的行 sed '/字符/d' filename 3)多点编辑 使用-e参数12删除第1-3行，替换某字符 sed -e '1,3d' -e 's/原字符/替换的字符/' filename 4)文件操作1234将含有某字段的行写入新的文件中 sed -n '/某字段/w 新文件' filename 将小写改为大写 sed 'y/小写字母/大写字母/' filename awk 通过正则表达式,得到需要的行,列信息123456 查看df -h命令的第2列 df -h | awk '&#123;print $2&#125;' 查看df -h命令的第2,5列 df -h | awk '&#123;print $2,$5&#125;' 列示月份及年份(\\n为换行符) date | awk '&#123;print \"Year:\" $6 \"\\nMonth:\" $2&#125;' sort 默认以排序ASCII方式进行排序[a-z] 参数: -u 去除重复的行 -r 降序排序[z-a] -n 数值排序,默认情况10比2小,主要因为sort判断第一字符的值 -k 以文本的列进行判断 -t 设定分界符123456 对/etc/passwd文件进行升序排序 sort /etc/passwd 对/etc/passwd文件进行降序排序 sort -r /etc/passwd 对/etc/passwd第3列进行数值排序,分界符为: sort -n -k 3 -t : /etc/passwd wc 统计行数、字数、字符数、文件总统计数 参数: -l 统计行数 -c 统计字节数 -w 统计字数(单词数 uniq 检查文本中重复出现的行 -c 显示输出,并在文本行前加出现的次数,但如果 重复行不连续，则不认为是重复的行 -d 只显示重复的行 -u 只显示不重复的行 -f n前N个字段和每个字段前的空白行一起被忽略,字段从0开始编号 -s n 前N个字符被忽略,字符从0开始编号 -w n 对N个字符以后的字符不在检查重复性 tee 读取标准输入的数据，并将其内容输出成文件 说明:指令会从标准输入设备读取数据，将其内容输出到标准输出设备，同时保存成文件 参数: -a:附加到既有文件的后面，而非覆盖它． -i:忽略中断信号。12 查询当前账户并写入who.txt文件中who | tee who.txt","categories":[{"name":"技术","slug":"技术","permalink":"http://yoursite.com/categories/技术/"}],"tags":[{"name":"Linux","slug":"Linux","permalink":"http://yoursite.com/tags/Linux/"}]}]